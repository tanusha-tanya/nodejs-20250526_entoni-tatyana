# Задание: Реализация чата с аутентификацией пользователей

В этом задании вы реализуете полноценный чат с использованием WebSocket, который включает аутентификацию пользователей и сохранение истории сообщений в базе данных.

## Общая структура задания

1. **Реализация аутентификации для WebSocket соединений**

   - Настроить проверку JWT-токена при установке WebSocket соединения
   - Отключать клиентов без валидного токена
   - Сохранять информацию о пользователе в данных соединения

2. **Обработка сообщений чата**

   - Реализовать получение сообщений от клиентов
   - Сохранять сообщения в базе данных
   - Отправлять сообщения всем подключенным пользователям

3. **Системные уведомления**

   - Отправлять системное уведомление всем пользователям при подключении нового участника

4. **История сообщений**
   - Реализовать REST эндпоинт для получения истории сообщений
   - Обеспечить защиту эндпоинта с помощью JWT Guard

## Технические требования

### 1. WebSocket соединение с аутентификацией

| Функциональность                     | Описание                                                                                           |
| ------------------------------------ | -------------------------------------------------------------------------------------------------- |
| Проверка токена                      | При установке соединения проверять JWT-токен, переданный в параметре `auth.token`                  |
| Отключение неавторизованных клиентов | Если токен отсутствует или недействителен, соединение должно быть закрыто                          |
| Сохранение данных пользователя       | Информация о пользователе должна быть сохранена в объекте соединения для дальнейшего использования |

### 2. Обработка сообщений

| Событие       | Описание                                                                                             |
| ------------- | ---------------------------------------------------------------------------------------------------- |
| `chatMessage` | Обрабатывает сообщение, отправленное клиентом, сохраняет его в базе данных и рассылает всем клиентам |

**Формат отправляемого сообщения**:

```json
{ "text": "Текст сообщения" }
```

**Формат сохраняемого и рассылаемого сообщения**:

```json
{
  "id": 1,
  "username": "username_from_jwt",
  "text": "Текст сообщения",
  "date": "2023-01-01T12:00:00Z"
}
```

### 3. Системные уведомления

При подключении нового пользователя, всем остальным пользователям должно быть отправлено уведомление в формате:

```json
{
  "username": "System",
  "text": "User username_from_jwt joined the chat.",
  "date": "2023-01-01T12:00:00Z"
}
```

### 4. Эндпоинт истории сообщений

| Метод | Ссылка        | Описание                          | Параметры                         |
| ----- | ------------- | --------------------------------- | --------------------------------- |
| GET   | /chat/history | Возвращает историю всех сообщений | Требует заголовок `Authorization` |

**Пример запроса**:

```http
GET http://localhost:3000/chat/history
Authorization: Bearer <ваш JWT-токен>
```

**Пример ответа** (если токен валиден):

```json
[
  {
    "id": 1,
    "username": "user1",
    "text": "Привет всем!",
    "date": "2023-01-01T12:00:00Z"
  },
  {
    "id": 2,
    "username": "user2",
    "text": "Привет, user1!",
    "date": "2023-01-01T12:01:00Z"
  }
]
```

**Пример ответа** (если токен недействителен или не передан):

```json
{
  "statusCode": 401,
  "message": "Unauthorized"
}
```

## Примечания

- Для проверки токена используйте JwtService из @nestjs/jwt
- При работе с WebSocket используйте библиотеку socket.io
- Для работы с базой данных используйте TypeORM
- Убедитесь, что ваш код соответствует принципам NestJS и хорошо структурирован
